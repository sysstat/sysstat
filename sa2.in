#!/bin/sh
# @SA_LIB_DIR@/sa2
# (C) 1999-2014 Sebastien Godard (sysstat <at> orange.fr)
#
#@(#) @PACKAGE_NAME@-@PACKAGE_VERSION@
#@(#) sa2: Write a daily report
#
S_TIME_FORMAT=ISO ; export S_TIME_FORMAT
umask 0022
prefix=@prefix@
exec_prefix=@exec_prefix@
SA_DIR=@SA_DIR@
SYSCONFIG_DIR=@SYSCONFIG_DIR@
HISTORY=@HISTORY@
COMPRESSAFTER=@COMPRESSAFTER@
ZIP="@ZIP@"
# if YESTERDAY="--date=yesterday" then yesterday's summary is generated
YESTERDAY=@YESTERDAY@

# Read configuration file, overriding variables set above
[ -r ${SYSCONFIG_DIR}/sysstat ] && . ${SYSCONFIG_DIR}/sysstat

[ -d ${SA_DIR} ] || SA_DIR=@SA_DIR@

if [ ${HISTORY} -gt 28 ]
then
	DATE=`date ${YESTERDAY} +%Y%m%d`
else
	DATE=`date ${YESTERDAY} +%d`
fi
CURRENTFILE=sa${DATE}
CURRENTRPT=sar${DATE}

RPT=${SA_DIR}/${CURRENTRPT}
DFILE=${SA_DIR}/${CURRENTFILE}
ENDIR=@bindir@

[ -f "${DFILE}" ] || exit 0
cd ${ENDIR}
${ENDIR}/sar $* -f ${DFILE} > ${RPT}

SAFILES_REGEX='/sar?[0-9]{2,8}(\.(Z|gz|bz2|xz|lz|lzo))?$'

find "${SA_DIR}" -type f -mtime +${HISTORY} \
	| egrep "${SAFILES_REGEX}" \
	| xargs   rm -f

UNCOMPRESSED_SAFILES_REGEX='/sar?[0-9]{2,8}$'

find "${SA_DIR}" -type f -mtime +${COMPRESSAFTER} \
	| egrep "${UNCOMPRESSED_SAFILES_REGEX}" \
	| xargs   "${ZIP}" > /dev/null

exit 0

